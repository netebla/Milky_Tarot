Milky Tarot Bot
================

–ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ (Docker)
------------------------

1. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` —Å–æ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏:

```
BOT_TOKEN=...
ADMIN_ID=...
TZ=Europe/Moscow
```

2. –°–æ–±–µ—Ä–∏—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:

```
docker compose up --build -d
```

–ü—Ä–æ–¥–∞–∫—à–Ω –∑–∞–ø—É—Å–∫ (Compose)
-------------------------

–í –ø—Ä–æ–¥–∞–∫—à–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `docker-compose.prod.yml`, –∫–æ—Ç–æ—Ä—ã–π —Ç—è–Ω–µ—Ç –æ–±—Ä–∞–∑ –∏–∑ GHCR. –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª `./data/users.json` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ `/app/src/data/users.json` –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å –∫–æ–¥ (–æ–±—Ä–∞–∑) –±–µ–∑ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–Ω–∏—è –±–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

CI/CD —á–µ—Ä–µ–∑ GitHub Actions
--------------------------

Workflow `.github/workflows/cicd.yml` –¥–µ–ª–∞–µ—Ç —Å–ª–µ–¥—É—é—â–µ–µ:

- –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è Docker-–æ–±—Ä–∞–∑–∞ –≤ GitHub Container Registry (`ghcr.io/<owner>/<repo>:latest` –∏ —Ç–µ–≥ SHA)
- SSH –¥–µ–ø–ª–æ–π –Ω–∞ –≤–∞—à—É –í–ú: –≤—ã–∫–ª–∞–¥—ã–≤–∞–µ—Ç `docker-compose.prod.yml`, –ø–∏—à–µ—Ç `.env`, –≤—ã–ø–æ–ª–Ω—è–µ—Ç `docker compose pull && up -d`

–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ GitHub Secrets:

- `SSH_HOST` ‚Äî IP/–¥–æ–º–µ–Ω –í–ú
- `SSH_USER` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å SSH
- `SSH_KEY` ‚Äî –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á (OpenSSH) –¥–ª—è SSH
- `SSH_PORT` ‚Äî –ø–æ—Ä—Ç SSH (–µ—Å–ª–∏ –Ω–µ 22)
- `BOT_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω Telegram-–±–æ—Ç–∞
- `ADMIN_ID` ‚Äî ID –∞–¥–º–∏–Ω–∞ (–º–æ–∂–Ω–æ —Å–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)

–ü—Ä–∏–º–µ—á–∞–Ω–∏—è
----------

- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `python:3.10-slim`, —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ `python -m bot.main`.
- –î–∞–Ω–Ω—ã–µ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ‚Äî –≤ `src/data`. –§–∞–π–ª `users.json` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏.
- –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `Europe/Moscow`.# Test CI/CD
# Test with secrets

–¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π "–ú–æ–∏ —Ä—ã–±–∫–∏" (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤)
-------------------------------------------

–î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø–ª–∞—Ç—ë–∂–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –¥–æ–±–∞–≤–ª–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ—Ç–æ–∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –≤–∞–ª—é—Ç—ã ‚Äî "—Ä—ã–±–∫–∏":

- –í –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é —É –∞–¥–º–∏–Ω–æ–≤ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ `–ú–æ–∏ —Ä—ã–±–∫–∏`.
- –ü–æ –Ω–∞–∂–∞—Ç–∏—é –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø–æ–ª–µ `fish_balance` —Ç–∞–±–ª–∏—Ü—ã `users` –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç:
  - –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é;
  - –ø–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å.
- –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ:
  - –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–∞—Ä–∏—Ñ—ã (50‚ÇΩ ‚Üí 350 üêü, 150‚ÇΩ ‚Üí 1050 üêü, 300‚ÇΩ ‚Üí 2100 üêü, 650‚ÇΩ ‚Üí 4550 üêü) –∏ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏ —Å –≤—ã–±–æ—Ä–æ–º —Ç–∞—Ä–∏—Ñ–∞;
  - –¥–∞–ª–µ–µ –ø—Ä–µ–¥–ª–∞–≥–∞—é—Ç—Å—è —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã (–°–ë–ü, –∫–∞—Ä—Ç–∞, –∑–≤—ë–∑–¥—ã Telegram);
  - –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã –±–æ—Ç –∏–º–∏—Ç–∏—Ä—É–µ—Ç —É—Å–ø–µ—à–Ω—É—é –æ–ø–ª–∞—Ç—É –∏ –Ω–∞—á–∏—Å–ª—è–µ—Ç —Ä—ã–±–∫–∏ (–≤–∫–ª—é—á–∞—è –±–æ–Ω—É—Å–Ω—ã–µ) –≤ `fish_balance`, —Å–æ–æ–±—â–∞—è –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å.
- –ù–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ –µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å:
  - –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —à–∞–≥ –Ω–∞–∑–∞–¥;
  - –ø–µ—Ä–µ–π—Ç–∏ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.

–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î
--------------

–í –º–æ–¥–µ–ª—å `User` (`src/utils/db.py`) –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ:

- `fish_balance` (`Integer`, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `0`) ‚Äî –±–∞–ª–∞–Ω—Å "—Ä—ã–±–æ–∫" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–î–ª—è —É–∂–µ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ–π PostgreSQL-–±–∞–∑—ã –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é:

```sql
ALTER TABLE users ADD COLUMN IF NOT EXISTS fish_balance integer DEFAULT 0;
```

–ï—Å–ª–∏ –±–∞–∑–∞ –∑–∞–ø—É—â–µ–Ω–∞ —á–µ—Ä–µ–∑ `docker-compose.yml` –∏–∑ —ç—Ç–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è, –ø—Ä–∏–º–µ—Ä –∫–æ–º–∞–Ω–¥ –Ω–∞ –í–ú:

```bash
docker exec -it tarot_db psql -U ${POSTGRES_USER:-tarot} -d ${POSTGRES_DB:-tarot_db} \
  -c "ALTER TABLE users ADD COLUMN IF NOT EXISTS fish_balance integer DEFAULT 0;"
```

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞:

```bash
docker compose restart bot
```

RAG-–∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Ä–∞—Å–∫–ª–∞–¥–æ–≤ —Å LLM
-------------------------------

–î–ª—è —Ä–∞—Å–∫–ª–∞–¥–æ–≤, –≥–¥–µ —Ç—Ä–∞–∫—Ç–æ–≤–∫–∞ —Å—Ç—Ä–æ–∏—Ç—Å—è —á–µ—Ä–µ–∑ LLM, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—â–∏–π –º–æ–¥—É–ª—å –ø—Å–µ–≤–¥–æ-RAG `src/llm/rag.py`:

- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–∞—Ä—Ç –±–µ—Ä—É—Ç—Å—è –∏–∑ `src/data/rag_cards.csv` (—Ñ–æ—Ä–º–∞—Ç: `–ù–∞–∑–≤–∞–Ω–∏–µ;–¢–µ–∫—Å—Ç`), –Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Ö –∫–∞—Ä—Ç, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ –≤—ã–ø–∞–ª–∏ –≤ —Ä–∞—Å–∫–ª–∞–¥–µ.
- –§—É–Ω–∫—Ü–∏—è `build_rag_prompt(base_prompt, cards)`:
  - —Å–æ–±–∏—Ä–∞–µ—Ç —Ç—Ä–∞–∫—Ç–æ–≤–∫–∏ –≤—ã–ø–∞–≤—à–∏—Ö –∫–∞—Ä—Ç;
  - –¥–æ–±–∞–≤–ª—è–µ—Ç –∏—Ö "–ø–æ–≤–µ—Ä—Ö" –±–∞–∑–æ–≤–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –∫–∞–∫ —Å–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (LLM –Ω–µ –¥–æ–ª–∂–µ–Ω —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ –Ω–µ–≥–æ –Ω–∞–ø—Ä—è–º—É—é).

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (—Ä–∞—Å–∫–ª–∞–¥ "–¢—Ä–∏ –∫–∞—Ä—Ç—ã"):

- –ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –≤ `src/llm/three_cards.py` —Ñ—É–Ω–∫—Ü–∏–µ–π `_build_base_prompt`.
- –ü–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º LLM –æ–Ω –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è:

```python
from llm.rag import build_rag_prompt

base_prompt = _build_base_prompt(cards, question)
prompt = build_rag_prompt(base_prompt, cards)
```

–¢–æ—á–Ω–æ —Ç–∞–∫–∏–º –∂–µ –æ–±—Ä–∞–∑–æ–º –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å RAG-–∫–æ–Ω—Ç–µ–∫—Å—Ç –∫ –ª—é–±—ã–º –±—É–¥—É—â–∏–º —Ä–∞—Å–∫–ª–∞–¥–∞–º, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è LLM.
