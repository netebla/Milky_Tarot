Milky Tarot Bot
================

–ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ (Docker)
------------------------

1. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` —Å–æ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏:

```
BOT_TOKEN=...
ADMIN_ID=...
TZ=Europe/Moscow
```

2. –°–æ–±–µ—Ä–∏—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:

```
docker compose up --build -d
```

–ü—Ä–æ–¥–∞–∫—à–Ω –∑–∞–ø—É—Å–∫ (Compose)
-------------------------

–í –ø—Ä–æ–¥–∞–∫—à–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `docker-compose.prod.yml`, –∫–æ—Ç–æ—Ä—ã–π —Ç—è–Ω–µ—Ç –æ–±—Ä–∞–∑ –∏–∑ GHCR. –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª `./data/users.json` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ `/app/src/data/users.json` –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å –∫–æ–¥ (–æ–±—Ä–∞–∑) –±–µ–∑ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–Ω–∏—è –±–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

CI/CD —á–µ—Ä–µ–∑ GitHub Actions
--------------------------

Workflow `.github/workflows/cicd.yml` –¥–µ–ª–∞–µ—Ç —Å–ª–µ–¥—É—é—â–µ–µ:

- –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è Docker-–æ–±—Ä–∞–∑–∞ –≤ GitHub Container Registry (`ghcr.io/<owner>/<repo>:latest` –∏ —Ç–µ–≥ SHA)
- SSH –¥–µ–ø–ª–æ–π –Ω–∞ –≤–∞—à—É –í–ú: –≤—ã–∫–ª–∞–¥—ã–≤–∞–µ—Ç `docker-compose.prod.yml`, –ø–∏—à–µ—Ç `.env`, –≤—ã–ø–æ–ª–Ω—è–µ—Ç `docker compose pull && up -d`

–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ GitHub Secrets:

- `SSH_HOST` ‚Äî IP/–¥–æ–º–µ–Ω –í–ú
- `SSH_USER` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å SSH
- `SSH_KEY` ‚Äî –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á (OpenSSH) –¥–ª—è SSH
- `SSH_PORT` ‚Äî –ø–æ—Ä—Ç SSH (–µ—Å–ª–∏ –Ω–µ 22)
- `BOT_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω Telegram-–±–æ—Ç–∞
- `ADMIN_ID` ‚Äî ID –∞–¥–º–∏–Ω–∞ (–º–æ–∂–Ω–æ —Å–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
- `PAYMENT_BOT_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –æ–ø–ª–∞—Ç—ã `@Milky_payment_bot`
- `YOOKASSA_SHOP_ID` ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞ –ÆKassa
- `YOOKASSA_SECRET_KEY` ‚Äî —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –ÆKassa
- `YOOKASSA_RETURN_URL` ‚Äî (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) URL –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `https://t.me/Milky_Tarot_Bot`

–ü—Ä–∏–º–µ—á–∞–Ω–∏—è
----------

- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `python:3.10-slim`, —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ `python -m bot.main`.
- –î–∞–Ω–Ω—ã–µ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ‚Äî –≤ `src/data`. –§–∞–π–ª `users.json` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏.
- –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `Europe/Moscow`.# Test CI/CD
# Test with secrets

–¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π "–ú–æ–∏ —Ä—ã–±–∫–∏" –∏ –æ–ø–ª–∞—Ç—ã (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤)
----------------------------------------------------

–î–æ–±–∞–≤–ª–µ–Ω –ø–ª–∞—Ç—ë–∂–Ω—ã–π –ø–æ—Ç–æ–∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –≤–∞–ª—é—Ç—ã ‚Äî "—Ä—ã–±–∫–∏", –¥–æ—Å—Ç—É–ø–Ω—ã–π –ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.

- –í –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–æ—Ç–∞ —É –∞–¥–º–∏–Ω–æ–≤ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ `–ú–æ–∏ —Ä—ã–±–∫–∏`.
- –ü–æ –Ω–∞–∂–∞—Ç–∏—é –æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ–ª–µ `fish_balance` –≤ —Ç–∞–±–ª–∏—Ü–µ `users`).
- –ö–Ω–æ–ø–∫–∞ `–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å üêü` –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –±–æ—Ç–µ —Å–µ–π—á–∞—Å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–µ—Ä–µ–π—Ç–∏ –≤ –±–æ—Ç–∞ –æ–ø–ª–∞—Ç—ã: `@Milky_payment_bot`.

–í–æ –≤—Ç–æ—Ä–æ–º –±–æ—Ç–µ –æ–ø–ª–∞—Ç—ã (`@Milky_payment_bot`):

- –ö–æ–º–∞–Ω–¥–∞ `/start` (–¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º) –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–∞—Ä–∏—Ñ—ã:
  - 50‚ÇΩ ‚Üí 350 üêü
  - 150‚ÇΩ ‚Üí 1050 üêü
  - 300‚ÇΩ ‚Üí 2100 üêü
  - 650‚ÇΩ ‚Üí 4550 üêü
- –ü—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–∞—Ä–∏—Ñ–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø–ª–∞—Ç—ë–∂ –≤ –ÆKassa —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä–Ω–æ–µ API:
  - –±–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–ª–∞—Ç—ë–∂ –≤ —Ç–∞–±–ª–∏—Ü—É `payments`;
  - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å—Å—ã–ª–∫—É `confirmation_url` –Ω–∞ –æ–ø–ª–∞—Ç—É;
  - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É ¬´–Ø –æ–ø–ª–∞—Ç–∏–ª, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å¬ª.
- –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ Telegram –∏ –Ω–∞–∂–∏–º–∞–µ—Ç ¬´–Ø –æ–ø–ª–∞—Ç–∏–ª, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å¬ª:
  - –±–æ—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –≤ –ÆKassa;
  - –ø—Ä–∏ `status = succeeded` –∏ `paid = true` –µ–¥–∏–Ω–æ—Ä–∞–∑–æ–≤–æ –Ω–∞—á–∏—Å–ª—è–µ—Ç `fish_amount` –≤ `users.fish_balance`;
  - –ø—Ä–∏ `canceled` —Å–æ–æ–±—â–∞–µ—Ç, —á—Ç–æ –ø–ª–∞—Ç—ë–∂ –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω;
  - –ø—Ä–∏ `pending` –ø—Ä–æ—Å–∏—Ç –ø–æ–¥–æ–∂–¥–∞—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–∑–∂–µ.

–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î
--------------

–í –º–æ–¥–µ–ª—å `User` (`src/utils/db.py`) –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ:

- `fish_balance` (`Integer`, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `0`) ‚Äî –±–∞–ª–∞–Ω—Å "—Ä—ã–±–æ–∫" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–î–ª—è —É–∂–µ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ–π PostgreSQL-–±–∞–∑—ã –ø–æ–ª–µ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ç–∞–∫:

```sql
ALTER TABLE users ADD COLUMN IF NOT EXISTS fish_balance integer DEFAULT 0;
```

–¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `payments` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –ÆKassa (`src/utils/db.py` ‚Äî –∫–ª–∞—Å—Å `Payment`):

- `id` ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–ª–∞—Ç–µ–∂–∞;
- `user_id` ‚Äî Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è;
- `yookassa_payment_id` ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–ª–∞—Ç–µ–∂–∞ –≤ –ÆKassa;
- `amount_rub` ‚Äî —Å—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö;
- `fish_amount` ‚Äî —Å–∫–æ–ª—å–∫–æ "—Ä—ã–±–æ–∫" –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞;
- `status` ‚Äî —Å—Ç–∞—Ç—É—Å (`pending`, `succeeded`, `canceled`, `error`);
- `method` ‚Äî —Ç–∏–ø –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞ –≤ –ÆKassa (–Ω–∞–ø—Ä–∏–º–µ—Ä, `bank_card`, `sbp`);
- `description` ‚Äî —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ;
- `created_at`, `updated_at` ‚Äî –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏.

–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã `payments` –≤ PostgreSQL:

```sql
CREATE TABLE IF NOT EXISTS payments (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,
    yookassa_payment_id VARCHAR NOT NULL UNIQUE,
    amount_rub INTEGER NOT NULL,
    fish_amount INTEGER NOT NULL,
    status VARCHAR NOT NULL DEFAULT 'pending',
    method VARCHAR,
    description VARCHAR,
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_payments_user_id ON payments(user_id);
CREATE INDEX IF NOT EXISTS idx_payments_status ON payments(status);
```

–ï—Å–ª–∏ –±–∞–∑–∞ –∑–∞–ø—É—â–µ–Ω–∞ —á–µ—Ä–µ–∑ `docker-compose.yml` –∏–∑ —ç—Ç–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è, –ø—Ä–∏–º–µ—Ä –∫–æ–º–∞–Ω–¥ –Ω–∞ –í–ú (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ë–î `tarot_db`, —Ä–æ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `postgres`):

```bash
# –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ fish_balance, –µ—Å–ª–∏ –µ–≥–æ –µ—â—ë –Ω–µ—Ç
docker exec -it tarot_db psql -U postgres -d tarot_db \
  -c "ALTER TABLE users ADD COLUMN IF NOT EXISTS fish_balance integer DEFAULT 0;"

# —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É payments (–µ—Å–ª–∏ –Ω–µ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ —Ä–∞–Ω–µ–µ)
docker exec -i tarot_db psql -U postgres -d tarot_db <<'SQL'
CREATE TABLE IF NOT EXISTS payments (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,
    yookassa_payment_id VARCHAR NOT NULL UNIQUE,
    amount_rub INTEGER NOT NULL,
    fish_amount INTEGER NOT NULL,
    status VARCHAR NOT NULL DEFAULT 'pending',
    method VARCHAR,
    description VARCHAR,
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_payments_user_id ON payments(user_id);
CREATE INDEX IF NOT EXISTS idx_payments_status ON payments(status);
SQL
```

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–æ–≤:

```bash
docker compose restart bot payment_bot
```

–ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥ "–¢—Ä–∏ –∫–ª—é—á–∞"
-------------------------------

–†–∞—Å–∫–ª–∞–¥ "–¢—Ä–∏ –∫–∞—Ä—Ç—ã" –±—ã–ª –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω –≤ —Å—Ü–µ–Ω–∞—Ä–∏–π "–¢—Ä–∏ –∫–ª—é—á–∞".

- –ö–Ω–æ–ø–∫–∞ –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é –¥–ª—è –∞–¥–º–∏–Ω–æ–≤: `–¢—Ä–∏ –∫–ª—é—á–∞`.
- –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏:
  - –∑–∞—Ä–∞–Ω–µ–µ –≤—ã–±–∏—Ä–∞—é—Ç—Å—è 3 –∫–∞—Ä—Ç—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ FSM;
  - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –¥–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º:
    - –ø–µ—Ä–≤–æ–µ ‚Äî –ø—Ä–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥ —Ä–∞–∑ –≤ –¥–µ–Ω—å –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Ä–∞—Å–∫–ª–∞–¥–æ–≤ –∑–∞ 69 üêü;
    - –≤—Ç–æ—Ä–æ–µ ‚Äî –ø—Ä–æ—Å—å–±–∞ —Å–Ω–∞—á–∞–ª–∞ –∫–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—Å–∞—Ç—å —Å–≤–æ—é —Å–∏—Ç—É–∞—Ü–∏—é.
  - –ø–æ–¥ –≤—Ç–æ—Ä—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ `–°—Ä–∞–∑—É –∫ –≤–æ–ø—Ä–æ—Å—É`.
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç:
  - –æ–ø–∏—Å—ã–≤–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ (–æ–Ω–∏ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –∫–∞–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞);
  - –∫–æ–≥–¥–∞ –≥–æ—Ç–æ–≤, –Ω–∞–∂–∞—Ç—å `–°—Ä–∞–∑—É –∫ –≤–æ–ø—Ä–æ—Å—É` –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —è–≤–Ω—ã–π –≤–æ–ø—Ä–æ—Å –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
- –î–ª—è —Ç—Ä–∞–∫—Ç–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è LLM (`src/llm/three_cards.py`), –ø—Ä–æ–º–ø—Ç —É—á–∏—Ç—ã–≤–∞–µ—Ç:
  - –∫–æ–Ω—Ç–µ–∫—Å—Ç (–æ–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏) –∫–∞–∫ —Ñ–æ–Ω;
  - —è–≤–Ω—ã–π –≤–æ–ø—Ä–æ—Å –∫–∞–∫ —Ñ–æ–∫—É—Å –æ—Ç–≤–µ—Ç–∞;
  - –∫–∞—Ä—Ç—ã —Ä–∞—Å–∫–ª–∞–¥–∞.
- –û—Ç–≤–µ—Ç LLM —Å—Ç—Ä–æ–∏—Ç—Å—è –∫–∞–∫ —Ç—Ä–∞–∫—Ç–æ–≤–∫–∞ —Ä–∞—Å–∫–ª–∞–¥–∞ "–¢—Ä–∏ –∫–ª—é—á–∞" —Å —É—á—ë—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –≤–æ–ø—Ä–æ—Å–∞.

–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –æ–ø–ª–∞—Ç–∞:

- –í –¥–µ–Ω—å –ø–µ—Ä–≤—ã–π —Ä–∞—Å–∫–ª–∞–¥ "–¢—Ä–∏ –∫–ª—é—á–∞" –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π.
- –ù–∞—á–∏–Ω–∞—è —Å–æ –≤—Ç–æ—Ä–æ–≥–æ —Ä–∞—Å–∫–ª–∞–¥–∞ –≤ —Ç–æ—Ç –∂–µ –¥–µ–Ω—å:
  - –µ—Å–ª–∏ `users.fish_balance >= 69` ‚Äî —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è 69 üêü, —Ä–∞—Å–∫–ª–∞–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è;
  - –µ—Å–ª–∏ `users.fish_balance < 69`:
    - —Ä–∞—Å–∫–ª–∞–¥ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è;
    - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –º–∞–≥–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∏—Å—á–µ—Ä–ø–∞–Ω–∞ –∏ –Ω—É–∂–Ω–æ –ø–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å;
    - –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ñ–∞–π–ª–∞ `src/data/images/hungry_milky.jpg` –æ–Ω –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –∫–∞–∫ –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è.

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –≤ –±–æ—Ç–µ –æ–ø–ª–∞—Ç—ã:

- –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–ª–∞—Ç–µ–∂–µ –ÆKassa –∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ —Ä—ã–±–æ–∫:
  - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ ¬´–°–ø–∞—Å–∏–±–æ –∑–∞ —Ä—ã–±–∫–∏!üíñüíñüíñ ‚Ä¶ –ü–∏—à–∏ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å ‚Äî —è —É–∂–µ –≥–æ—Ç–æ–≤–∞ –≤—ã—Ç—è–Ω—É—Ç—å –∫–∞—Ä—Ç—ã –¥–ª—è —Ç–µ–±—è üêà‚Äç‚¨õ¬ª.
  - –µ—Å–ª–∏ –≤ –æ–±—Ä–∞–∑–µ –µ—Å—Ç—å —Ñ–∞–π–ª `src/data/images/fed_milky.jpg`, –æ–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å —ç—Ç–∏–º —Ç–µ–∫—Å—Ç–æ–º.

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ `User` –¥–ª—è "–¢—Ä—ë—Ö –∫–ª—é—á–µ–π":

- `three_keys_last_date` (`Date`) ‚Äî –¥–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–∞—Å–∫–ª–∞–¥–∞ "–¢—Ä–∏ –∫–ª—é—á–∞";
- `three_keys_daily_count` (`Integer`, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `0`) ‚Äî —Å–∫–æ–ª—å–∫–æ —Ä–∞—Å–∫–ª–∞–¥–æ–≤ "–¢—Ä–∏ –∫–ª—é—á–∞" –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å.

–ú–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –±–∞–∑—ã:

```sql
ALTER TABLE users ADD COLUMN IF NOT EXISTS three_keys_last_date date;
ALTER TABLE users ADD COLUMN IF NOT EXISTS three_keys_daily_count integer DEFAULT 0;
```

–ü—Ä–∏–º–µ—Ä –∫–æ–º–∞–Ω–¥ –Ω–∞ –í–ú (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `tarot_db`, —Ä–æ–ª—å `postgres`):

```bash
docker exec -i tarot_db psql -U postgres -d tarot_db <<'SQL'
ALTER TABLE users ADD COLUMN IF NOT EXISTS three_keys_last_date date;
ALTER TABLE users ADD COLUMN IF NOT EXISTS three_keys_daily_count integer DEFAULT 0;
SQL
```

–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ /admin_stats
-----------------------

–ö–æ–º–∞–Ω–¥–∞ `/admin_stats` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:

- `üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π` ‚Äî –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ `users`.
- `üî• –ê–∫—Ç–∏–≤–Ω—ã —Å–µ–≥–æ–¥–Ω—è` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–µ–≥–æ–¥–Ω—è –≤—ã—Ç—è–Ω—É–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–∞—Ä—Ç—É:
  - `User.draw_count > 0` –∏ `User.last_activity_date = —Å–µ–≥–æ–¥–Ω—è`.
- `üÉè –í—ã—Ç—è–Ω—É—Ç–æ –∫–∞—Ä—Ç (–≤—Å–µ–≥–æ)` ‚Äî —Å—É–º–º–∞ –ø–æ–ª—è `User.draw_count` –ø–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.

RAG-–∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Ä–∞—Å–∫–ª–∞–¥–æ–≤ —Å LLM
-------------------------------

–î–ª—è —Ä–∞—Å–∫–ª–∞–¥–æ–≤, –≥–¥–µ —Ç—Ä–∞–∫—Ç–æ–≤–∫–∞ —Å—Ç—Ä–æ–∏—Ç—Å—è —á–µ—Ä–µ–∑ LLM, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—â–∏–π –º–æ–¥—É–ª—å –ø—Å–µ–≤–¥–æ-RAG `src/llm/rag.py`:

- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–∞—Ä—Ç –±–µ—Ä—É—Ç—Å—è –∏–∑ `src/data/rag_cards.csv` (—Ñ–æ—Ä–º–∞—Ç: `–ù–∞–∑–≤–∞–Ω–∏–µ;–¢–µ–∫—Å—Ç`), –Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Ö –∫–∞—Ä—Ç, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ –≤—ã–ø–∞–ª–∏ –≤ —Ä–∞—Å–∫–ª–∞–¥–µ.
- –§—É–Ω–∫—Ü–∏—è `build_rag_prompt(base_prompt, cards)`:
  - —Å–æ–±–∏—Ä–∞–µ—Ç —Ç—Ä–∞–∫—Ç–æ–≤–∫–∏ –≤—ã–ø–∞–≤—à–∏—Ö –∫–∞—Ä—Ç;
  - –¥–æ–±–∞–≤–ª—è–µ—Ç –∏—Ö "–ø–æ–≤–µ—Ä—Ö" –±–∞–∑–æ–≤–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –∫–∞–∫ —Å–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (LLM –Ω–µ –¥–æ–ª–∂–µ–Ω —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ –Ω–µ–≥–æ –Ω–∞–ø—Ä—è–º—É—é).

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (—Ä–∞—Å–∫–ª–∞–¥ "–¢—Ä–∏ –∫–∞—Ä—Ç—ã"):

- –ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –≤ `src/llm/three_cards.py` —Ñ—É–Ω–∫—Ü–∏–µ–π `_build_base_prompt`.
- –ü–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º LLM –æ–Ω –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è:

```python
from llm.rag import build_rag_prompt

base_prompt = _build_base_prompt(cards, question)
prompt = build_rag_prompt(base_prompt, cards)
```

–¢–æ—á–Ω–æ —Ç–∞–∫–∏–º –∂–µ –æ–±—Ä–∞–∑–æ–º –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å RAG-–∫–æ–Ω—Ç–µ–∫—Å—Ç –∫ –ª—é–±—ã–º –±—É–¥—É—â–∏–º —Ä–∞—Å–∫–ª–∞–¥–∞–º, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è LLM.
